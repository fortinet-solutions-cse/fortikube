config server-policy service custom
  edit "K8s API HTTPS"
    set port 6443
  next
  edit "K8S PetStore HTTP"
    set port 8080
  next
end

config waf openapi-file
  edit "swagger-3.0.json"
  next
  edit "petstore.json"
  next
  edit "swagger-petstore-3.0.json"
  next
end

config waf openapi-validation-policy
  edit "OpenAPI Validation Policy"
    set action alert_deny
    config  schema-file
      edit 2
        set openapi-file swagger-3.0.json
      next
    end
  next
  edit "OpenAPI Validation Policy - PetStore"
    set action alert_deny
    config  schema-file
      edit 1
        set openapi-file swagger-petstore-3.0.json
      next
    end
  next
end

config server-policy vserver
  edit "K8s API Server"
    config  vip-list
      edit 1
        set interface port2
        set use-interface-ip enable
      next
    end
  next
  edit "Application"
    config  vip-list
      edit 1
        set interface port2
        set use-interface-ip enable
      next
    end
  next
end

config waf web-protection-profile inline-protection
  edit "Inline OpenAPI protection"
    set signature-rule "Standard Protection"
    set file-upload-policy WebShell-Uploading
    set redirect-url http://
    set custom-access-policy "Predefined - Advanced Protection"
    set ip-intelligence enable
    set profile-id 16193788435334543594
    set openapi-validation-policy "OpenAPI Validation Policy"
    set bot-mitigate-policy "Predefined - Bot Mitigation"
  next
  edit "Inline OpenAPI protection - PetStore"
    set signature-rule "Standard Protection"
    set file-upload-policy WebShell-Uploading
    set redirect-url http://
    set custom-access-policy "Predefined - Advanced Protection"
    set ip-intelligence enable
    set profile-id 6332908249809352942
    set openapi-validation-policy "OpenAPI Validation Policy - PetStore"
    set bot-mitigate-policy "Predefined - Bot Mitigation"
  next
end

config server-policy persistence-policy
end
config server-policy server-pool
  edit "K8s API Server"
    set flag 1
    set server-pool-id 11486922600693133141
    config  pserver-list
      edit 1
        set ip 10.210.9.140
        set port 6443
        set server-id 8800138244270272061
        set ssl enable
        set tls-v10 disable
        set tls-v11 disable
        set ssl-noreg disable
        set ssl-custom-cipher ECDHE-ECDSA-AES256-GCM-SHA384 ECDHE-RSA-AES256-GCM-SHA384 ECDHE-ECDSA-CHACHA20-POLY1305 ECDHE-RSA-CHACHA20-POLY1305 ECDHE-ECDSA-AES128-GCM-SHA256 ECDHE-RSA-AES128-GCM-SHA256 ECDHE-ECDSA-AES256-SHA384 ECDHE-RSA-AES256-SHA384 ECDHE-ECDSA-AES128-SHA256 ECDHE-RSA-AES128-SHA256 ECDHE-ECDSA-AES256-SHA ECDHE-RSA-AES256-SHA ECDHE-ECDSA-AES128-SHA ECDHE-RSA-AES128-SHA AES256-GCM-SHA384 AES128-GCM-SHA256 AES256-SHA256 AES128-SHA256 
        set http2 enable
        set http2-ssl-custom-cipher ECDHE-RSA-AES256-GCM-SHA384 ECDHE-ECDSA-AES256-GCM-SHA384 DHE-DSS-AES128-GCM-SHA256 DHE-RSA-AES128-GCM-SHA256 
      next
    end
  next
  edit "PetStore Application"
    set server-pool-id 1771821221985930349
    config  pserver-list
      edit 1
        set ip 10.210.9.140
        set port 31380
        set server-id 14036706625068680777
      next
    end
  next
end

config server-policy policy
  edit "K8s_API_Server_policy"
    set ssl enable
    set vserver "K8s API Server"
    set web-protection-profile "Inline OpenAPI protection"
    set replacemsg Predefined
    set server-pool "K8s API Server"
    set https-service "K8s API HTTPS"
    set ssl-custom-cipher ECDHE-ECDSA-AES256-GCM-SHA384 ECDHE-RSA-AES256-GCM-SHA384 ECDHE-ECDSA-CHACHA20-POLY1305 ECDHE-RSA-CHACHA20-POLY1305 ECDHE-ECDSA-AES128-GCM-SHA256 ECDHE-RSA-AES128-GCM-SHA256 ECDHE-ECDSA-AES256-SHA384 ECDHE-RSA-AES256-SHA384 ECDHE-ECDSA-AES128-SHA256 ECDHE-RSA-AES128-SHA256 ECDHE-ECDSA-AES256-SHA ECDHE-RSA-AES256-SHA ECDHE-ECDSA-AES128-SHA ECDHE-RSA-AES128-SHA AES256-GCM-SHA384 AES128-GCM-SHA256 AES256-SHA256 AES128-SHA256 
    set policy-id 1636079389827815207
    config  http-content-routing-list
    end
  next
  edit "K8S_PetStore_Policy"
    set vserver Application
    set service "K8S PetStore HTTP"
    set web-protection-profile "Inline OpenAPI protection - PetStore"
    set replacemsg Predefined
    set server-pool "PetStore Application"
    set policy-id 2578843133079852571
    config  http-content-routing-list
    end
  next
end